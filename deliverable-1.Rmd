---
title: "deliverable-1"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Loading data
Cargamos los datos guardados en el fichero set-Datos.RData. En este fichero hay la muestra de 5000 individuos que se usará para el análisis. Podemos comprobar que la dimensión de los datos es correcto, 5000 filas y 21 columnas.

```{r}

setwd("C:/Users/Sergio/Dropbox/UPC/FIB/Analisis de datos y explotacion de la informacion (ADEI)/FIB-ADEI-Big-Data-Analysis")
#setwd("C:/Users/GUILLEM/Documents/ADEI/FIB-ADEI-Big-Data-Analysis")
#setwd("C:/Users/usuario/Documents/ADEI/FIB-ADEI-Big-Data-Analysis")


load("set-datos.RData", envir = parent.frame(), verbose = FALSE)

#Comprobar el tamaño de la muestra
dim(df)
```

# Exploratory Data Analysis

# crear lista de cuantitativos y cualitativos

```{r}
#Separamos variables target/no-target numéricas/categóricas (observamos un individuo cualquiera)

df[1,]
vars_target<-c("duration","y");vars_target
vars_cat<-c("job", "marital", "education", "default", "housing", "loan", "contact", "month", "day_of_week", "poutcome");vars_cat
vars_num<-c("age", "campaign", "pdays", "previous", "emp.var.rate", "cons.price.idx", "cons.conf.idx", "euribor3m", "nr.employed");vars_num
```


```{r}
# Graphics
names(df)
# Overview of data frame 
summary(df)

#Analizamos variables según si son cat/num o target/no-target (obtenemos 4 clasificaciones)
#target+categorica (miramos qué nivles tiene)
levels(df$y) #solo hay yes/no no hay que hacer nada

#target+numerica (miramos qué valores toma)
summary(df$duration)#Vemos que hay valores muy pequeños, incluso 0, tambien de muy grandes.
hist(df$duration,100) #Miramos distribución
boxplot(df$duration) #Hacemos boxplot para ver outliers
calcQ <- function(x) {# Some useful functions
  s.x <- summary(x)
  iqr<-s.x[5]-s.x[2]
  list(souti=s.x[2]-3*iqr, mouti=s.x[2]-1.5*iqr, min=s.x[1], q1=s.x[2], q2=s.x[3], 
       q3=s.x[5], max=s.x[6], mouts=s.x[5]+1.5*iqr, souts=s.x[5]+3*iqr ) }
out.var<-calcQ(df$duration);out.var
abline(h=650,col="red",lwd=2) #Fijamos límite soft
abline(h=979,col="magenta",lwd=2) #Fijamos límite extreme
aux<-order(df$duration,decreasing=TRUE)[1:10];df[aux,'duration'] #Hechamos un ojo a los 10 valores más extremos
df<-df[-aux[1:6],]#decidimos eliminamos los 6 elementos más extremos 
boxplot(df$duration) #Hacemos boxplot de nuevo
aux<-which(df$duration<5);length(aux);df[aux,'duration']#Ahora miramos los que son inferiores a 5s (no puede considerarse llamada)
df<-df[-aux,]#decidimos eliminarlos todos



#no-target+categorica


for(i in vars_cat){
  cat("################ ",i," ##################\n")
  print(summary(df[,i]))
} #Vemos un resumen de los niveles de cada variable categorica
for(i in vars_cat){#Vamos a poner NA's en los unknows
  
  sel<-which(df[,i]=="unknown")
  
  if(length(sel)>0 && length(sel)<300){ cat(i, " -- ", length(sel), "\n")
  df[sel,i]<-NA
  df[,i]<-factor(df[,i])
  }
}
#sel<-which(df$poutcome=="nonexistent")#Hacemos lo mismo con poutcome y sus nonexitent
#print(length(sel))
#df[sel,'poutcome']<-NA
#df$poutcome<-factor(df$poutcome)
library(missMDA)

aux<- df[c(2:10,15)];names(aux) #variables categoricas sin la categoria "default"
res.input<-imputeMCA(aux,ncp=10)#preguntar hay diferencia entre imputar antes o despues de unir subcategorias
summary(res.input$completeObs)

head(df)

# Guardamos los datos en este punto
#save.image("set-datos-cat-imputados.RData")
load("set-datos-cat-imputados.RData", envir = parent.frame(), verbose = FALSE)

# NO IMPRIMIR EN EL DOCUMENTO ---------------------------

#job- imputacion correcta
summary(df[,vars_cat[1]])
summary(res.input$completeObs[,1])
df[,vars_cat[1]]<-res.input$completeObs[,1]

#marital- imputacion correcta
summary(df[,vars_cat[2]])
summary(res.input$completeObs[,2])
df[,vars_cat[2]]<-res.input$completeObs[,2]

#education- imputacion correcta
summary(df[,vars_cat[3]])
summary(res.input$completeObs[,3])
df[,vars_cat[3]]<-res.input$completeObs[,3]

#default- 
summary(df[,vars_cat[4]])
summary(res.input$completeObs[,4])
#df[,vars_cat[4]]<-res.input$completeObs[,4]   # preguntar si dejamos el yes=0  o no y preguntar por que no funciona la imputacion

#housing
summary(df[,vars_cat[5]])
summary(res.input$completeObs[,5])
df[,vars_cat[5]]<-res.input$completeObs[,5]

#loan
summary(df[,vars_cat[6]])
summary(res.input$completeObs[,6])
df[,vars_cat[6]]<-res.input$completeObs[,6]

#contact
summary(df[,vars_cat[7]])
summary(res.input$completeObs[,7])
df[,vars_cat[7]]<-res.input$completeObs[,7]

#month
summary(df[,vars_cat[8]])
summary(res.input$completeObs[,8])
df[,vars_cat[8]]<-res.input$completeObs[,8]

#day of week
summary(df[,vars_cat[9]])
summary(res.input$completeObs[,9])
df[,vars_cat[9]]<-res.input$completeObs[,9]

#poutcome
summary(df[,vars_cat[10]])
summary(res.input$completeObs[,10])
df[,vars_cat[10]]<-res.input$completeObs[,10]


# Refactorización (Agrupar subcategorias en menos categorias)

for(i in vars_cat){
  cat("################ ",i," ##################\n")
  print(summary(df[,i]))
}

# preguntar como criterio para las agrupaciones categoricas y en numericas

#Job

table(df$job)
#     admin.   blue-collar  entrepreneur     housemaid    management       retired self-employed     
#         1296          1156           189           119           351           222           166   
#    services       student    technician  unemployed 
#         451           109           817      114 

# Define new factor categories: 1-Activo 2-No activo 3-Estudiante
df$f.job <- 3
# 1 level - Activo 
sel<-which(df$job %in% c("admin.", "blue-collar", "entrepreneur", "management", "self-employed","services","technician"))
df$f.job[sel] <-1

# 2 level - No activo 
sel<-which(df$job %in% c("housemaid", "retired","unemployed"))
df$f.job[sel] <-2

# 3 level - Estudiante
sel<-which(df$job %in% c("student"))
df$f.job[sel] <-3

table(df$f.job);summary(df$f.job)
df$f.job<-factor(df$f.job,levels=1:3,labels=c("Active","No active","Student"))


# Month a Season

table(df$month)
# apr  aug  dec  jul  jun  mar  may  nov  oct  sep 
# 321  764   18  865  616   63 1680  513   80   70 

# Define new factor categories: 1- Spring 2-Summer 3-Resta
df$f.season <- 3
# 1 level - spring 
sel<-which(df$month %in% c("mar","apr","may"))
df$f.season[sel] <-1

# 2 level - Summer 
sel<-which(df$month %in% c("jun","jul","aug"))
df$f.season[sel] <-2

# 3 level - Aut-Win
sel<-which(df$month %in% c("dec","sep","oct","nov"))
df$f.season[sel] <-3

table(df$f.season);summary(df$f.season)
df$f.season<-factor(df$f.season,levels=1:3,labels=c("Spring","Summer","Aut-Win"))

#Education

# education a Season

table(df$education)
#	basic.4y            basic.6y            basic.9y         high.school          illiterate professional.course   university.degree 
#	  515                 271                 810                1196                   1                 633                1564

# Define new factor categories: 1-Basic 2-High School 3-Professional 4-illiterate
df$f.education <- 4
# 1 level - Basic 
sel<-which(df$education %in% c("basic.4y","basic.6y","basic.9y"))
df$f.education[sel] <-1

# 2 level - Higb School 
sel<-which(df$education %in% c("high.school"))
df$f.education[sel] <-2

# 3 level - Professional
sel<-which(df$education %in% c("professional.course","university.degree"))
df$f.education[sel] <-3

# 3 level - Illiterate
sel<-which(df$education %in% c("illiterate"))
df$f.education[sel] <-4



table(df$f.education);summary(df$f.education)
df$f.education<-factor(df$f.education,levels=1:4,labels=c("Basic","High School","Professional","Illiterate"))



# FIN DE NO IMPRIMIR EN EL DOCUMENTO ---------------------------

#save.image("set-datos-cat-imputados.RData")
load("set-datos-cat-imputados.RData", envir = parent.frame(), verbose = FALSE)


#no-target+numerica


```

# Revisión de cada variable con summary y boxplots

```{r}
	# age - Consideramos que no presenta ningún outlier  # preguntar si esta bien

	# campaign - Consideramos que en los 10 meses que dura la campaña, contactar a un cliente como maximo cada 15 días puede ser posible
	summary(df$campaign)
	hist(df$campaign,col="cyan",main="campaign - Histogram")
	boxplot(df$campaign, labels=row.names(df))

	out.var<-calcQ(df$campaign);out.var
	abline(h=out.var[8],col="red",lwd=2) #Fijamos límite soft
	abline(h=out.var[9],col="magenta",lwd=2) #Fijamos límite extreme
	aux<-which(df$campaign>20);length(aux);df[aux,'campaign'] #Hechamos un ojo a los 10 valores más extremos
	df[aux,"campaign"]<-NA # los ponemos como NA's
	boxplot(df$campaign) #Hacemos boxplot de nuevo
	

	# pdays - preguntar creemos que no hay outliers, solo se han contactado a 175 personas en la campaña previa
	summary(df$pdays)
	aux2<-which(df$pdays<999);summary(df$pdays[aux2])
	aux<-df$pdays[aux2]
	hist(aux,col="cyan",main="pdays - Histogram")
	boxplot(aux, labels=row.names(df))

	out.var<-calcQ(aux);out.var
	abline(h=out.var[8],col="red",lwd=2) #Fijamos límite soft
	abline(h=out.var[9],col="magenta",lwd=2) #Fijamos límite extreme
	aux<-which(df$pdays>20);length(aux);df[aux,'pdays'] #Hechamos un ojo a los 10 valores más extremos
	df[aux,"pdays"]<-NA # los ponemos como NA's
	boxplot(df$pdays) #Hacemos boxplot de nuevo



	# previous - preguntar - Nosotros consideramos que no hay outliers
	summary(df$previous)
	hist(df$previous,col="cyan",main="previous - Histogram")
	boxplot(df$previous, labels=row.names(df))

	out.var<-calcQ(df$previous);out.var
	abline(h=out.var[8],col="red",lwd=2) #Fijamos límite soft
	abline(h=out.var[9],col="magenta",lwd=2) #Fijamos límite extreme
	aux<-which(df$previous>20);length(aux);df[aux,'previous'] #Hechamos un ojo a los 10 valores más extremos
	df[aux,"previous"]<-NA # los ponemos como NA's
	boxplot(df$previous) #Hacemos boxplot de nuevo



	# emp.var.rate
	summary(df$emp.var.rate)
	hist(df$emp.var.rate,col="cyan",main="emp.var.rate - Histogram")
	boxplot(df$emp.var.rate, labels=row.names(df))

	out.var<-calcQ(df$emp.var.rate);out.var
	abline(h=out.var[8],col="red",lwd=2) #Fijamos límite soft
	abline(h=out.var[9],col="magenta",lwd=2) #Fijamos límite extreme
	aux<-which(df$emp.var.rate>20);length(aux);df[aux,'emp.var.rate'] #Hechamos un ojo a los 10 valores más extremos
	df[aux,"emp.var.rate"]<-NA # los ponemos como NA's
	boxplot(df$emp.var.rate) #Hacemos boxplot de nuevo



	# cons.price.idx
	summary(df$cons.price.idx)
	hist(df$cons.price.idx,col="cyan",main="cons.price.idx - Histogram")
	boxplot(df$cons.price.idx, labels=row.names(df))

	out.var<-calcQ(df$cons.price.idx);out.var
	abline(h=out.var[8],col="red",lwd=2) #Fijamos límite soft
	abline(h=out.var[9],col="magenta",lwd=2) #Fijamos límite extreme
	aux<-which(df$cons.price.idx>20);length(aux);df[aux,'cons.price.idx'] #Hechamos un ojo a los 10 valores más extremos
	df[aux,"cons.price.idx"]<-NA # los ponemos como NA's
	boxplot(df$cons.price.idx) #Hacemos boxplot de nuevo



	# cons.conf.idx
	summary(df$cons.conf.idx)
	hist(df$cons.conf.idx,col="cyan",main="cons.conf.idx - Histogram")
	boxplot(df$cons.conf.idx, labels=row.names(df))

	out.var<-calcQ(df$cons.conf.idx);out.var
	abline(h=out.var[8],col="red",lwd=2) #Fijamos límite soft
	abline(h=out.var[9],col="magenta",lwd=2) #Fijamos límite extreme
	aux<-which(df$cons.conf.idx>20);length(aux);df[aux,'cons.conf.idx'] #Hechamos un ojo a los 10 valores más extremos
	df[aux,"cons.conf.idx"]<-NA # los ponemos como NA's
	boxplot(df$cons.conf.idx) #Hacemos boxplot de nuevo



	# euribor3m
	summary(df$euribor3m)
	hist(df$euribor3m,col="cyan",main="euribor3m - Histogram")
	boxplot(df$euribor3m, labels=row.names(df))

	out.var<-calcQ(df$euribor3m);out.var
	abline(h=out.var[8],col="red",lwd=2) #Fijamos límite soft
	abline(h=out.var[9],col="magenta",lwd=2) #Fijamos límite extreme
	aux<-which(df$euribor3m>20);length(aux);df[aux,'euribor3m'] #Hechamos un ojo a los 10 valores más extremos
	df[aux,"euribor3m"]<-NA # los ponemos como NA's
	boxplot(df$euribor3m) #Hacemos boxplot de nuevo



	# nr.employed
	summary(df$nr.employed)
	hist(df$nr.employed,col="cyan",main="nr.employed - Histogram")
	boxplot(df$nr.employed, labels=row.names(df))

	out.var<-calcQ(df$nr.employed);out.var
	abline(h=out.var[8],col="red",lwd=2) #Fijamos límite soft
	abline(h=out.var[9],col="magenta",lwd=2) #Fijamos límite extreme
	aux<-which(df$nr.employed>20);length(aux);df[aux,'nr.employed'] #Hechamos un ojo a los 10 valores más extremos
	df[aux,"nr.employed"]<-NA # los ponemos como NA's
	boxplot(df$nr.employed) #Hacemos boxplot de nuevo


```


# missing values de las variables target

# missing values 

# missing values de outliers


# Crear factores adicionales para cada variable cuantitativa
```{r}
# Para Age
qulist<-quantile(df$age,seq(0,1,0.25),na.rm=TRUE)

varaux<-factor(cut(df$age,breaks=qulist,include.lowest=T))
table(varaux)
tapply(df$age,varaux,median)
varaux<-factor(cut(df$age,breaks=c(18,30,40,50,92),include.lowest=T))
table(varaux)
tapply(df$age,varaux,median)

df$f.age<-factor(cut(df$age,breaks=c(18,30,40,50,92),include.lowest=T))

summary(df$f.age)
levels(df$f.age)<-paste0("f.age-",levels(df$f.age))

# Para duration
qulist<-quantile(df$duration,seq(0,1,0.25),na.rm=TRUE)

varaux<-factor(cut(df$duration,breaks=qulist,include.lowest=T))
table(varaux)
tapply(df$duration,varaux,median)
varaux<-factor(cut(df$duration,breaks=c(18,30,40,50,92),include.lowest=T))
table(varaux)
tapply(df$duration,varaux,median)

df$f.duration<-factor(cut(df$age,breaks=c(18,30,40,50,92),include.lowest=T))

summary(df$f.age)
levels(df$f.age)<-paste0("f.age-",levels(df$f.age))

```
